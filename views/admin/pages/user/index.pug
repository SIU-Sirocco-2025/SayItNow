extends ../../layouts/default.pug

block main
    .user-header
        h2 Quản lý User

    .user-container
        .table-responsive
            table.user-table
                thead
                    tr
                        th.d-none.d-md-table-cell #
                        th FullName
                        th.d-none.d-sm-table-cell Email
                        th.d-none.d-lg-table-cell Ngày tạo
                        th Hành động
                tbody#userTable
                    tr
                        td(colspan="5", style="text-align: center; padding: 2rem; color: #94a3b8;") Đang tải...
        
        //- Mobile card view
        #userCards.user-cards.d-md-none

    style.
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--slate-200);
        }

        .user-header h2 {
            margin: 0;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--slate-900);
        }

        @media (max-width: 576px) {
            .user-header h2 {
                font-size: 1.25rem;
            }
        }

        /* Mobile card view */
        .user-cards {
            display: none;
        }

        .user-card {
            background: #fff;
            border: 1px solid var(--slate-200);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .user-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .user-card-name {
            font-weight: 600;
            color: var(--slate-900);
            font-size: 1rem;
        }

        .user-card-email {
            font-size: 0.85rem;
            color: var(--slate-600);
            margin-top: 0.25rem;
            word-break: break-all;
        }

        .user-card-date {
            font-size: 0.75rem;
            color: var(--slate-400);
            margin-top: 0.5rem;
        }

        .user-card-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--slate-100);
        }

        .user-card-actions button {
            flex: 1;
        }

        @media (max-width: 767px) {
            .user-container .table-responsive {
                display: none;
            }
            .user-cards {
                display: block;
            }
        }

        .btn-add {
            background: var(--green-500);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
        }

        .btn-add:hover {
            background: var(--green-600);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .user-container {
            background: #fff;
            border-radius: 1rem;
            padding: 1.75rem;
            border: 1px solid var(--slate-200);
            overflow-x: auto;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        .user-table thead {
            background: var(--slate-50);
        }

        .user-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--slate-900);
            border-bottom: 2px solid var(--slate-200);
        }

        .user-table td {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid var(--slate-100);
            color: var(--slate-700);
        }

        .user-table tbody tr:hover {
            background: var(--slate-50);
        }

        .status-badge {
            display: inline-block;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-inactive {
            background: #fef3c7;
            color: #92400e;
        }

        .status-blocked {
            background: #fee2e2;
            color: #991b1b;
        }

        .role-badge {
            display: inline-block;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            font-weight: 600;
            background: var(--slate-200);
            color: var(--slate-800);
        }

        .role-badge.admin {
            background: #dbeafe;
            color: #1e40af;
        }

        .role-badge.moderator {
            background: #fce7f3;
            color: #be185d;
        }

        .action-btns {
            display: flex;
            gap: 0.5rem;
        }

        .btn-edit, .btn-delete {
            padding: 0.375rem 0.75rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
        }

        .btn-edit {
            background: #f59e0b;
            color: white;
        }

        .btn-edit:hover {
            background: #d97706;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

    script.
        function loadUsers() {
            fetch('/admin/user/api/list')
                .then(r => r.json())
                .then(data => {
                    if (!data.success) return;
                    const tbody = document.getElementById('userTable');
                    const cardsContainer = document.getElementById('userCards');
                    tbody.innerHTML = '';
                    cardsContainer.innerHTML = '';
                    
                    data.users.forEach((user, idx) => {
                        const createdAt = new Date(user.createdAt).toLocaleDateString('vi-VN');
                        
                        // Table row for desktop
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="d-none d-md-table-cell">${idx + 1}</td>
                            <td>${user.fullName}</td>
                            <td class="d-none d-sm-table-cell">${user.email}</td>
                            <td class="d-none d-lg-table-cell">${createdAt}</td>
                            <td>
                                <div class="action-btns">
                                    <button class="btn-edit" onclick="resetUserPassword('${user._id}', '${user.fullName}')">Reset PW</button>
                                    <button class="btn-delete" onclick="deleteUser('${user._id}')">Xóa</button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                        
                        // Card for mobile
                        const card = document.createElement('div');
                        card.className = 'user-card';
                        card.innerHTML = `
                            <div class="user-card-header">
                                <div>
                                    <div class="user-card-name">${user.fullName}</div>
                                    <div class="user-card-email">${user.email}</div>
                                    <div class="user-card-date">Tạo: ${createdAt}</div>
                                </div>
                            </div>
                            <div class="user-card-actions">
                                <button class="btn-edit" onclick="resetUserPassword('${user._id}', '${user.fullName}')">Reset PW</button>
                                <button class="btn-delete" onclick="deleteUser('${user._id}')">Xóa</button>
                            </div>
                        `;
                        cardsContainer.appendChild(card);
                    });
                });
        }

        function resetUserPassword(id, fullName) {
            if (confirm(`Bạn chắc chắn muốn reset password cho user ${fullName}?\nMật khẩu mới sẽ là: 123456`)) {
                fetch(`/admin/user/api/reset-password/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        alert('Reset password thành công!\nMật khẩu mới: 123456');
                        loadUsers();
                    } else {
                        alert('Lỗi: ' + data.message);
                    }
                });
            }
        }

        function deleteUser(id) {
            if (confirm('Bạn chắc chắn muốn xóa user này?')) {
                fetch(`/admin/user/api/delete/${id}`, { method: 'DELETE' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            alert('Xóa thành công');
                            loadUsers();
                        } else {
                            alert('Lỗi: ' + data.message);
                        }
                    });
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadUsers);
        } else {
            loadUsers();
        }
